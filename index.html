<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactief Spel: Vraag & Aanbod met AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .graph-option {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .graph-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .correct {
            border-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        .incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #api-key-modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- API Key Modal -->
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">API Sleutel Vereist</h2>
            <p class="text-slate-600 mb-6">Om de AI-functies te gebruiken, heeft u een gratis Google AI Studio API-sleutel nodig. Plak deze hieronder.</p>
            <input type="password" id="api-key-input" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Plak uw API-sleutel hier">
            <div class="flex gap-4 mt-6">
                 <button id="close-modal-button" class="w-full bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Annuleren</button>
                <button id="save-api-key-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Opslaan</button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="block text-sm text-blue-600 hover:underline mt-6">Hoe kom ik aan een API-sleutel?</a>
        </div>
    </div>

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg relative">
        <!-- Settings Button -->
        <button id="settings-button" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>

        <div id="start-screen" class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">Spel: Vraag & Aanbod Verschuivingen</h1>
            <p class="text-slate-600 mb-6 max-w-2xl mx-auto">Test je kennis over de dynamiek van vraag en aanbod. Kies bij elk scenario de juiste grafische weergave.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="start-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                    Start het Spel
                </button>
                 <button id="generate-scenario-button" class="flex items-center justify-center bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors text-lg">
                    <span class="mr-2">✨</span> Verzin een Scenario
                    <div id="generate-spinner" class="spinner ml-3 hidden"></div>
                </button>
            </div>
            <p id="generate-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>

        <div id="question-screen" class="hidden">
            <div class="mb-6">
                <p id="question-counter" class="text-sm font-semibold text-blue-600">Vraag 1 / 15</p>
                <h2 class="text-xl sm:text-2xl font-bold text-slate-900 mt-2">Markt: <span id="markt-text" class="font-normal"></span></h2>
                <p id="scenario-text" class="mt-2 text-slate-700 bg-slate-100 p-4 rounded-lg"></p>
            </div>

            <div id="options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <!-- Graph options will be inserted here by JavaScript -->
            </div>
            
            <div id="feedback-section" class="mt-6 hidden">
                <h3 id="feedback-title" class="text-xl font-bold"></h3>
                <p id="explanation-text" class="mt-2 text-slate-700"></p>
                 <button id="analyze-button" class="mt-4 flex items-center bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    <span class="mr-2">✨</span> Geef een Diepere Analyse
                    <div id="analyze-spinner" class="spinner ml-3 hidden"></div>
                </button>
                <div id="analysis-container" class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg hidden">
                    <h4 class="font-bold text-purple-800">Diepere Analyse</h4>
                    <p id="analysis-text" class="text-purple-900 mt-2"></p>
                    <p id="analysis-error" class="text-red-500 mt-2 text-sm hidden"></p>
                </div>
                <button id="next-button" class="mt-4 w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                    Volgende Vraag
                </button>
            </div>
        </div>

        <div id="end-screen" class="hidden text-center">
             <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">Spel Voltooid!</h1>
             <p class="text-2xl text-slate-700 mb-4">Je score:</p>
             <p id="score-text" class="text-5xl font-bold text-blue-600 mb-8">18 / 20</p>
             <p id="score-feedback" class="text-slate-600 mb-8 max-w-2xl mx-auto"></p>
             <button id="restart-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                Opnieuw Spelen
            </button>
        </div>
    </div>

    <script>
        // --- DATASET MET OPGAVEN ---
        let opgaven = [];
        const initialOpgaven = [
            {
                situatie: 1,
                markt: "De markt voor elektrische fietsen.",
                scenario: "De overheid introduceert een subsidie voor de aankoop van een nieuwe elektrische fiets om duurzaam vervoer te stimuleren.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { move: 'vraag', direction: 'omhoog' }, id: 'C' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "De subsidie maakt het voor consumenten goedkoper om een elektrische fiets te kopen, waardoor ze bij elke gegeven prijs meer fietsen willen en kunnen kopen. Dit is een externe factor (overheidsbeleid) die de vraag beïnvloedt, dus de gehele vraaglijn verschuift naar rechts."
            },
            {
                situatie: 2,
                markt: "De markt voor vliegtickets naar zonnige bestemmingen.",
                scenario: "Het inkomen van de consumenten is het afgelopen jaar fors gestegen.",
                opties: [
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'A' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'C' },
                    { type: { move: 'vraag', direction: 'omlaag' }, id: 'D' }
                ],
                correct: 'B',
                uitleg: "Vliegreizen naar zonnige bestemmingen zijn een luxe goed. Wanneer het inkomen van consumenten stijgt, kunnen en willen ze bij elke prijs meer van dit soort reizen kopen. Dit leidt tot een verschuiving van de vraaglijn naar rechts."
            },
            {
                situatie: 3,
                markt: "De markt voor concertkaarten van een specifieke artiest.",
                scenario: "De artiest raakt 'uit de mode' na een serie negatieve publicaties in de media.",
                opties: [
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'A' },
                    { type: { move: 'vraag', direction: 'omlaag' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'C' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'D' }
                ],
                correct: 'D',
                uitleg: "Door de gedaalde populariteit (verandering in voorkeur) willen minder mensen een kaartje voor het concert, ongeacht de prijs. De vraag naar kaartjes daalt bij elke prijs, wat resulteert in een verschuiving van de vraaglijn naar links."
            },
            {
                situatie: 4,
                markt: "De markt voor Coca-Cola.",
                scenario: "De prijs van Pepsi, een concurrerend merk, wordt aanzienlijk verlaagd.",
                opties: [
                    { type: { shift: 'vraag', direction: 'links' }, id: 'A' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'C' },
                    { type: { move: 'vraag', direction: 'omlaag' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "Pepsi en Coca-Cola zijn substitutiegoederen. Als de prijs van Pepsi daalt, zullen consumenten overstappen van Coca-Cola naar het goedkopere alternatief. Hierdoor daalt de vraag naar Coca-Cola bij elke prijs, en verschuift de vraaglijn naar links."
            },
            {
                situatie: 5,
                markt: "De markt voor gameconsoles.",
                scenario: "De prijs van populaire computerspellen (games), die je nodig hebt om op de console te spelen, daalt spectaculair.",
                opties: [
                    { type: { shift: 'vraag', direction: 'links' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'C' },
                    { type: { move: 'aanbod', direction: 'omhoog' }, id: 'D' }
                ],
                correct: 'C',
                uitleg: "Gameconsoles en games zijn complementaire goederen. Als games goedkoper worden, wordt het aantrekkelijker om een gameconsole aan te schaffen. De vraag naar consoles stijgt daardoor bij elke prijs, wat leidt tot een verschuiving van de vraaglijn naar rechts."
            },
            {
                situatie: 6,
                markt: "De markt voor streamingdiensten (zoals Netflix).",
                scenario: "Een grote concurrent (zoals Disney+) verhoogt zijn abonnementsprijs aanzienlijk.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'B' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'C' },
                    { type: { move: 'vraag', direction: 'omhoog' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "Omdat de concurrent (een substituut) duurder wordt, zullen sommige consumenten overstappen. Hierdoor stijgt de vraag naar deze streamingdienst bij elke prijs, wat leidt tot een verschuiving van de vraaglijn naar rechts."
            },
            {
                situatie: 7,
                markt: "De markt voor avocados.",
                scenario: "Een extreme droogte in belangrijke productielanden zoals Mexico en Peru vernietigt een groot deel van de oogst.",
                opties: [
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'B' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'C' },
                    { type: { move: 'aanbod', direction: 'omhoog' }, id: 'D' }
                ],
                correct: 'C',
                uitleg: "De mislukte oogst is een aanbodschok. Er zijn bij elke prijs minder avocado's beschikbaar op de wereldmarkt. Dit leidt tot een afname van het aanbod, wat een verschuiving van de aanbodlijn naar links betekent."
            },
            {
                situatie: 8,
                markt: "De markt voor vintage kleding.",
                scenario: "Duurzaamheid wordt een enorme trend onder jongeren, terwijl tegelijkertijd steeds meer kringloopwinkels en online platformen (zoals Vinted) opkomen.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'rechts' }, id: 'C' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'links' }, id: 'D' }
                ],
                correct: 'C',
                uitleg: "Twee dingen gebeuren hier: 1) De voorkeur voor duurzaamheid verhoogt de vraag (vraaglijn naar rechts). 2) Het grotere aantal verkopers verhoogt het aanbod (aanbodlijn naar rechts). Beide lijnen verschuiven dus naar rechts."
            },
            {
                situatie: 9,
                markt: "De markt voor zonnepanelen.",
                scenario: "De overheid introduceert een forse productiesubsidie voor fabrikanten van zonnepanelen om groene energie te stimuleren.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'C' },
                    { type: { move: 'aanbod', direction: 'omlaag' }, id: 'D' }
                ],
                correct: 'B',
                uitleg: "Een subsidie voor producenten verlaagt hun productiekosten. Hierdoor kunnen en willen ze bij elke prijs meer zonnepanelen aanbieden. Dit resulteert in een verschuiving van de aanbodlijn naar rechts."
            },
            {
                situatie: 10,
                markt: "De markt voor nieuwe benzineauto's.",
                scenario: "De benzineprijs bereikt een recordhoogte en blijft stijgen, terwijl de overheid tegelijkertijd een dure, verplichte nieuwe uitstootfilter voor alle nieuwe auto's eist.",
                opties: [
                    { type: { shift: 'vraag', direction: 'links' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'B' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'links' }, id: 'C' },
                    { type: { shift: 'beide', directionV: 'links', directionA: 'links' }, id: 'D' }
                ],
                correct: 'D',
                uitleg: "Een dubbel effect: 1) Hoge benzineprijzen maken het bezit van een benzineauto (een complementair goed) minder aantrekkelijk, dus de vraag daalt (vraaglijn naar links). 2) De verplichte filter verhoogt de productiekosten, dus het aanbod daalt (aanbodlijn naar links)."
            },
            {
                situatie: 11,
                markt: "De markt voor handdesinfectiemiddelen.",
                scenario: "Het griepseizoen blijkt onverwacht mild te zijn met zeer weinig besmettingen landelijk.",
                opties: [
                    { type: { shift: 'vraag', direction: 'links' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'C' },
                    { type: { move: 'vraag', direction: 'omlaag' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "De behoefte en de waargenomen noodzaak om handdesinfectiemiddel te kopen daalt sterk. Door deze verandering in voorkeur/noodzaak daalt de vraag bij elke prijs, en verschuift de vraaglijn naar links."
            },
            {
                situatie: 12,
                markt: "De markt voor veganistische vleesvervangers.",
                scenario: "Een groot wetenschappelijk onderzoek toont aan dat deze producten significant bijdragen aan een langer en gezonder leven. Tegelijkertijd wordt een nieuwe productietechniek ontdekt die de kosten halveert.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'beide', directionV: 'links', directionA: 'rechts' }, id: 'C' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'rechts' }, id: 'D' }
                ],
                correct: 'D',
                uitleg: "Een perfecte storm: 1) Het positieve nieuws verhoogt de voorkeur en dus de vraag (vraaglijn naar rechts). 2) De lagere productiekosten verhogen het aanbod (aanbodlijn naar rechts). Beide lijnen verschuiven naar rechts."
            },
            {
                situatie: 13,
                markt: "De markt voor geschoolde bouwvakkers (arbeidsmarkt).",
                scenario: "De overheid start een gigantisch nationaal project om de komende tien jaar 200.000 huizen te bouwen.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'rechts' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'links' }, id: 'C' },
                    { type: { move: 'aanbod', direction: 'omhoog' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "Het bouwproject verhoogt de vraag naar een productiefactor: arbeid. Bouwbedrijven hebben bij elk loon (prijs van arbeid) meer bouwvakkers nodig. De vraaglijn naar arbeid verschuift dus naar rechts."
            },
            {
                situatie: 14,
                markt: "De markt voor papieren boeken.",
                scenario: "De prijzen van e-readers en e-books dalen aanzienlijk door massaproductie.",
                opties: [
                    { type: { shift: 'vraag', direction: 'links' }, id: 'A' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'B' },
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'C' },
                    { type: { move: 'vraag', direction: 'omlaag' }, id: 'D' }
                ],
                correct: 'A',
                uitleg: "E-books zijn een substituut voor papieren boeken. Nu het alternatief goedkoper is geworden, zal de vraag naar papieren boeken bij elke prijs afnemen. De vraaglijn verschuift naar links."
            },
            {
                situatie: 15,
                markt: "De markt voor festivaltickets.",
                scenario: "De organisatie kondigt een wereldberoemde, extreem populaire artiest aan als hoofdact. Tegelijkertijd worden de veiligheidseisen strenger, waardoor er minder bezoekers op het terrein worden toegelaten.",
                opties: [
                    { type: { shift: 'vraag', direction: 'rechts' }, id: 'A' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'links' }, id: 'B' },
                    { type: { shift: 'aanbod', direction: 'links' }, id: 'C' },
                    { type: { shift: 'beide', directionV: 'rechts', directionA: 'rechts' }, id: 'D' }
                ],
                correct: 'B',
                uitleg: "Weer twee effecten: 1) De populaire artiest zorgt voor een enorme toename in de vraag (vraaglijn naar rechts). 2) De beperkte capaciteit betekent een afname van het aanbod van tickets (aanbodlijn naar links)."
            }
        ];
        opgaven = [...initialOpgaven];

        // --- GAME STATE ---
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;

        // --- DOM ELEMENTS ---
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const settingsButton = document.getElementById('settings-button');
        
        const startScreen = document.getElementById('start-screen');
        const questionScreen = document.getElementById('question-screen');
        const endScreen = document.getElementById('end-screen');
        
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const nextButton = document.getElementById('next-button');
        const generateScenarioButton = document.getElementById('generate-scenario-button');
        const generateSpinner = document.getElementById('generate-spinner');
        const generateError = document.getElementById('generate-error');
        const analyzeButton = document.getElementById('analyze-button');
        const analyzeSpinner = document.getElementById('analyze-spinner');
        const analysisContainer = document.getElementById('analysis-container');
        const analysisText = document.getElementById('analysis-text');
        const analysisError = document.getElementById('analysis-error');

        const questionCounter = document.getElementById('question-counter');
        const marktText = document.getElementById('markt-text');
        const scenarioText = document.getElementById('scenario-text');
        const optionsGrid = document.getElementById('options-grid');
        
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackTitle = document.getElementById('feedback-title');
        const explanationText = document.getElementById('explanation-text');
        const scoreText = document.getElementById('score-text');
        const scoreFeedback = document.getElementById('score-feedback');


        // --- SVG GRAPH DRAWING FUNCTION ---
        function drawGraph(containerId, graphType) {
            const width = 200;
            const height = 150;
            const padding = 20;
            const arrowSize = 6;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.setAttribute("class", "mx-auto");

            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.innerHTML = `
                <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#64748b" stroke-width="1.5"/>
                <line x1="${padding}" y1="${height - padding}" x2="${padding}" y2="${padding}" stroke="#64748b" stroke-width="1.5"/>
                <text x="${width - padding + 5}" y="${height - padding + 5}" font-size="12" fill="#64748b" font-weight="bold">Q</text>
                <text x="${padding - 15}" y="${padding + 5}" font-size="12" fill="#64748b" font-weight="bold">P</text>
            `;
            svg.appendChild(g);

            const drawLine = (p1, p2, color, dashed = false) => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", p1.x); line.setAttribute("y1", p1.y);
                line.setAttribute("x2", p2.x); line.setAttribute("y2", p2.y);
                line.setAttribute("stroke", color); line.setAttribute("stroke-width", "2");
                if (dashed) line.setAttribute("stroke-dasharray", "4 2");
                return line;
            }
            
            const drawArrow = (from, to, color) => {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", from.x); line.setAttribute("y1", from.y);
                line.setAttribute("x2", to.x); line.setAttribute("y2", to.y);
                line.setAttribute("stroke", color); line.setAttribute("stroke-width", "1.5");
                g.appendChild(line);
                const angle = Math.atan2(to.y - from.y, to.x - from.x);
                const head = document.createElementNS("http://www.w3.org/2000/svg", "path");
                head.setAttribute("d", `M ${to.x} ${to.y} L ${to.x - arrowSize * Math.cos(angle - Math.PI / 6)} ${to.y - arrowSize * Math.sin(angle - Math.PI / 6)} L ${to.x - arrowSize * Math.cos(angle + Math.PI / 6)} ${to.y - arrowSize * Math.sin(angle + Math.PI / 6)} Z`);
                head.setAttribute("fill", color);
                g.appendChild(head);
                return g;
            }

            const v_p1 = { x: padding + 25, y: padding + 10 };
            const v_p2 = { x: width - padding - 25, y: height - padding - 10 };
            const a_p1 = { x: padding + 25, y: height - padding - 10 };
            const a_p2 = { x: width - padding - 25, y: padding + 10 };

            svg.appendChild(drawLine(v_p1, v_p2, '#3b82f6'));
            const v_text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            v_text.setAttribute("x", v_p2.x + 5); v_text.setAttribute("y", v_p2.y + 5);
            v_text.setAttribute("font-size", "12"); v_text.setAttribute("fill", "#3b82f6");
            v_text.textContent = "V"; svg.appendChild(v_text);

            svg.appendChild(drawLine(a_p1, a_p2, '#f97316'));
            const a_text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            a_text.setAttribute("x", a_p2.x + 5); a_text.setAttribute("y", a_p2.y - 5);
            a_text.setAttribute("font-size", "12"); a_text.setAttribute("fill", "#f97316");
            a_text.textContent = "A"; svg.appendChild(a_text);

            const shiftAmount = 25;
            if (graphType.shift) {
                if (graphType.shift === 'vraag' || graphType.shift === 'beide') {
                    const dir = graphType.direction === 'rechts' || graphType.directionV === 'rechts' ? 1 : -1;
                    const v_new_p1 = { x: v_p1.x + dir * shiftAmount, y: v_p1.y };
                    const v_new_p2 = { x: v_p2.x + dir * shiftAmount, y: v_p2.y };
                    svg.appendChild(drawLine(v_new_p1, v_new_p2, '#3b82f6', true));
                    const arrowY = height * 0.75;
                    svg.appendChild(drawArrow({x: width/2 - dir*5, y: arrowY}, {x: width/2 + dir*10, y: arrowY}, '#3b82f6'));
                }
                 if (graphType.shift === 'aanbod' || graphType.shift === 'beide') {
                    const dir = graphType.direction === 'rechts' || graphType.directionA === 'rechts' ? 1 : -1;
                    const a_new_p1 = { x: a_p1.x + dir * shiftAmount, y: a_p1.y };
                    const a_new_p2 = { x: a_p2.x + dir * shiftAmount, y: a_p2.y };
                    svg.appendChild(drawLine(a_new_p1, a_new_p2, '#f97316', true));
                    const arrowY = height * 0.25;
                    svg.appendChild(drawArrow({x: width/2 - dir*5, y: arrowY}, {x: width/2 + dir*10, y: arrowY}, '#f97316'));
                }
            } else if (graphType.move) {
                 // Block is intentionally empty.
            } else if (graphType.price_control) {
                const pos = graphType.position === 'onder' ? 1 : -1;
                const y = height/2 + pos * 30;
                const line = drawLine({x: padding, y}, {x: width - padding, y}, '#16a34a', true);
                line.setAttribute('stroke-width', '2.5'); svg.appendChild(line);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", width-padding+5); text.setAttribute("y", y+4);
                text.setAttribute("font-size", "10"); text.setAttribute("fill", "#16a34a");
                text.textContent = graphType.price_control === 'max' ? "Pmax" : "Pmin";
                svg.appendChild(text);
            }

            document.getElementById(containerId).appendChild(svg);
        }

        // --- GAME LOGIC FUNCTIONS ---
        function showQuestion() {
            answered = false;
            feedbackSection.classList.add('hidden');
            analysisContainer.classList.add('hidden');
            analyzeButton.disabled = false;
            optionsGrid.innerHTML = '';
            
            const q = opgaven[currentQuestionIndex];
            questionCounter.textContent = `Vraag ${currentQuestionIndex + 1} / ${opgaven.length}`;
            marktText.textContent = q.markt;
            scenarioText.textContent = q.scenario;

            q.opties.forEach(option => {
                const optionEl = document.createElement('button');
                optionEl.className = 'graph-option border-2 border-slate-200 rounded-lg p-4 bg-white cursor-pointer text-left';
                optionEl.dataset.id = option.id;

                const label = document.createElement('div');
                label.className = 'font-bold text-lg mb-2';
                label.textContent = `Grafiek ${option.id}`;
                
                const graphContainer = document.createElement('div');
                graphContainer.id = `graph-${option.id}`;
                
                optionEl.appendChild(label);
                optionEl.appendChild(graphContainer);
                optionsGrid.appendChild(optionEl);

                drawGraph(graphContainer.id, option.type);

                optionEl.addEventListener('click', () => handleAnswer(option.id));
            });
        }

        function handleAnswer(selectedId) {
            if (answered) return;
            answered = true;

            const q = opgaven[currentQuestionIndex];
            const isCorrect = selectedId === q.correct;
            
            if (isCorrect) {
                score++;
                feedbackTitle.textContent = "Correct!";
                feedbackTitle.className = "text-xl font-bold text-green-600";
            } else {
                feedbackTitle.textContent = "Helaas, niet correct.";
                feedbackTitle.className = "text-xl font-bold text-red-600";
            }
            
            explanationText.innerHTML = `<span class="font-bold">Uitleg:</span> ${q.uitleg}`;
            feedbackSection.classList.remove('hidden');

            document.querySelectorAll('.graph-option').forEach(btn => {
                btn.disabled = true;
                const btnId = btn.dataset.id;
                if (btnId === q.correct) btn.classList.add('correct');
                else if (btnId === selectedId) btn.classList.add('incorrect');
            });
        }

        function showEndScreen() {
            questionScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            scoreText.textContent = `${score} / ${opgaven.length}`;
            
            let feedback = "Goed gedaan!";
            const percentage = score / opgaven.length;
            if (percentage < 0.5) feedback = "Dat kan beter, probeer het nog een keer om de concepten te oefenen.";
            else if (percentage < 0.8) feedback = "Een mooie score! Je bent goed op weg.";
            else feedback = "Uitstekend werk! Je hebt de dynamiek van vraag en aanbod goed onder de knie."
            scoreFeedback.textContent = feedback;
        }

        // --- API KEY MANAGEMENT ---
        function showApiKeyModal() {
            apiKeyModal.classList.remove('hidden');
        }

        function hideApiKeyModal() {
            apiKeyModal.classList.add('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                hideApiKeyModal();
            }
        }

        function getApiKey() {
            return localStorage.getItem('geminiApiKey');
        }

        // --- GEMINI API FUNCTIONS ---
        async function callGemini(prompt, isJson = false) {
             const apiKey = getApiKey();
             if (!apiKey) {
                showApiKeyModal();
                throw new Error("API-sleutel niet gevonden.");
             }
             
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "markt": { "type": "STRING" },
                            "scenario": { "type": "STRING" },
                            "verschuiving": { "type": "STRING" },
                            "uitleg": { "type": "STRING" }
                        },
                        required: ["markt", "scenario", "verschuiving", "uitleg"]
                    }
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API verzoek mislukt met status: ${response.status}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Ongeldig antwoordformaat van API.");
                }
            } catch (error) {
                console.error("Fout bij het aanroepen van de Gemini API:", error);
                throw error;
            }
        }
        
        // --- EVENT LISTENERS ---
        settingsButton.addEventListener('click', showApiKeyModal);
        closeModalButton.addEventListener('click', hideApiKeyModal);
        saveApiKeyButton.addEventListener('click', saveApiKey);

        startButton.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            questionScreen.classList.remove('hidden');
            showQuestion();
        });

        async function handleAiFeature(button, spinner, errorElement, prompt, isJson, successCallback) {
            spinner.classList.remove('hidden');
            errorElement.classList.add('hidden');
            button.disabled = true;

            try {
                const result = await callGemini(prompt, isJson);
                successCallback(result);
            } catch (error) {
                errorElement.textContent = `Fout: ${error.message}. Heeft u een geldige API-sleutel ingesteld?`;
                errorElement.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        }

        generateScenarioButton.addEventListener('click', () => {
            const prompt = `Genereer een uniek en creatief economisch scenario voor een vraag- en aanbodspel voor middelbare scholieren (havo/vwo niveau). Het scenario moet een duidelijke verschuiving van ofwel de vraaglijn, ofwel de aanbodlijn veroorzaken. Geef een korte uitleg. Antwoord in het Nederlands. De verschuiving moet een van de volgende zijn: 'vraag naar rechts', 'vraag naar links', 'aanbod naar rechts', 'aanbod naar links'.`;
            
            handleAiFeature(generateScenarioButton, generateSpinner, generateError, prompt, true, (jsonResponse) => {
                const aiOpgave = JSON.parse(jsonResponse);

                const shiftMap = {
                    'vraag naar rechts': { shift: 'vraag', direction: 'rechts' },
                    'vraag naar links': { shift: 'vraag', direction: 'links' },
                    'aanbod naar rechts': { shift: 'aanbod', direction: 'rechts' },
                    'aanbod naar links': { shift: 'aanbod', direction: 'links' },
                };
                
                const correctType = shiftMap[aiOpgave.verschuiving.toLowerCase()];
                if (!correctType) throw new Error("Onbekende verschuiving van AI.");

                const distractors = Object.values(shiftMap).filter(v => v.shift !== correctType.shift || v.direction !== correctType.direction);
                distractors.push({ move: 'vraag', direction: 'omlaag' });
                distractors.sort(() => Math.random() - 0.5);

                const options = [ { type: correctType, id: 'A' } ];
                for(let i=0; i<3; i++) {
                    options.push({ type: distractors[i], id: String.fromCharCode(66 + i) });
                }
                options.sort(() => Math.random() - 0.5);
                const correctId = options.find(o => o.type.shift === correctType.shift && o.type.direction === correctType.direction).id;

                const newQuestion = {
                    situatie: opgaven.length + 1,
                    markt: aiOpgave.markt,
                    scenario: aiOpgave.scenario,
                    opties: options,
                    correct: correctId,
                    uitleg: aiOpgave.uitleg,
                    isAiGenerated: true
                };

                opgaven.push(newQuestion);
                currentQuestionIndex = opgaven.length - 1;
                score = 0;
                
                startScreen.classList.add('hidden');
                questionScreen.classList.remove('hidden');
                showQuestion();
            });
        });

        analyzeButton.addEventListener('click', () => {
            const q = opgaven[currentQuestionIndex];
            const prompt = `Analyseer het volgende economische scenario voor een middelbare scholier. Leg in 2-3 zinnen uit wat de mogelijke tweede-orde-effecten zijn, of geef een relevant, actueel voorbeeld uit de echte wereld. Het scenario is: '${q.scenario}' op de markt voor '${q.markt}'. De basisuitleg is: '${q.uitleg}'. Geef alleen de diepere analyse, in het Nederlands.`;
            
            handleAiFeature(analyzeButton, analyzeSpinner, analysisError, prompt, false, (analysisResult) => {
                analysisText.textContent = analysisResult;
                analysisContainer.classList.remove('hidden');
            });
        });

        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < opgaven.length) {
                showQuestion();
            } else {
                showEndScreen();
            }
        });

        restartButton.addEventListener('click', () => {
            opgaven = [...initialOpgaven];
            currentQuestionIndex = 0;
            score = 0;
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
    </script>
</body>
</html>
